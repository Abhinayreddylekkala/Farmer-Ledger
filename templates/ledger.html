<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ledger: {{ farmer_name }}</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: rgba(0,0,0,0.8); display: flex; justify-content: center; padding-top: 20px; min-height: 100vh; margin: 0; }
        .ledger-card { background: white; width: 100%; max-width: 700px; border-radius: 8px; padding: 25px; position: relative; display: flex; flex-direction: column; max-height: 95vh; }
        .card-header { font-size: 1.4em; font-weight: bold; border-bottom: 2px solid #eee; padding-bottom: 10px; display: flex; justify-content: space-between; }
        
        /* ‚úÖ NEW SEARCH BAR STYLES */
        .search-bar { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; gap: 10px; align-items: flex-end; border: 1px solid #bbdefb; }
        .date-input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em; }
        .btn-search { background: #333; color: white; border: none; padding: 9px 15px; border-radius: 4px; cursor: pointer; }
        .btn-clear { background: #999; color: white; text-decoration: none; padding: 9px 15px; border-radius: 4px; display: inline-block; }

        .payment-form { background: #e8f5e9; padding: 15px; border-radius: 5px; margin-bottom: 15px; border: 1px solid #c8e6c9; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .pay-input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; flex-grow: 1; }
        .btn-pay { background: #2e7d32; color: white; border: none; padding: 9px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        
        .section-title { font-size: 0.9em; font-weight: bold; color: #555; margin-top: 15px; margin-bottom: 5px; text-transform: uppercase; border-bottom: 1px solid #ddd; }
        .tx-list { overflow-y: auto; flex-grow: 1; padding-right: 5px; }
        .tx-item { border-bottom: 1px solid #f0f0f0; padding: 10px 0; display: flex; align-items: flex-start; gap: 10px; }
        .tx-payment { background-color: #fbe9e7; } 

        .tx-content { flex-grow: 1; }
        .tx-header { display: flex; justify-content: space-between; }
        .tx-title { font-weight: bold; font-size: 0.9em; }
        .tx-amount { font-weight: bold; font-size: 1.1em; }
        .bill-amount { color: #d32f2f; }
        .pay-amount { color: #2e7d32; }
        
        .footer { margin-top: auto; border-top: 2px solid #333; padding-top: 15px; display: flex; justify-content: space-between; align-items: center; }
        .final-bal { font-weight: bold; font-size: 1.4em; color: #d32f2f; }
        .btn-print { background: #2980b9; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .close-btn { text-decoration: none; color: #999; font-size: 2em; line-height: 0.5; }
        
        .actions { margin-top: 5px; text-align: right; }
        .btn-edit { color: #2980b9; font-weight: bold; text-decoration: none; margin-right: 10px; font-size: 0.9em; }
        .delete-x { color: red; border: none; background: none; cursor: pointer; font-weight: bold; font-size: 1.2em; }
        .btn-undo { background: #ddd; border: none; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 1em; }
    </style>
</head>
<body>

    <form id="print-form" action="{{ url_for('print_selected') }}" method="POST"></form>

    <div class="ledger-card">
        <div class="card-header">
            <span>{{ farmer_name }}</span>
            <a href="{{ url_for('dashboard') }}" class="close-btn">√ó</a>
        </div>

        <form method="GET" action="{{ url_for('ledger', farmer_name=farmer_name) }}" class="search-bar">
            <div>
                <small>From:</small><br>
                <input type="date" name="start_date" class="date-input" value="{{ start_date if start_date else '' }}">
            </div>
            <div>
                <small>To:</small><br>
                <input type="date" name="end_date" class="date-input" value="{{ end_date if end_date else '' }}">
            </div>
            <div>
                <br>
                <button type="submit" class="btn-search">üîç Search</button>
                <a href="{{ url_for('ledger', farmer_name=farmer_name) }}" class="btn-clear">Clear</a>
            </div>
        </form>

        <form action="{{ url_for('add_payment', farmer_name=farmer_name) }}" method="POST" class="payment-form">
            <span style="font-weight:bold; color:#2e7d32;">üí∏ Add Payment:</span>
            <input type="date" name="date" class="pay-input" id="payDate" required>
            <input type="number" name="amount" placeholder="Amount (‚Çπ)" class="pay-input" required>
            <select name="method" class="pay-input">
                <option value="Cash">Cash</option>
                <option value="PhonePe">PhonePe</option>
                <option value="GPay">GPay</option>
                <option value="Bank">Bank</option>
            </select>
            <button type="submit" class="btn-pay">Save</button>
        </form>

        <div class="tx-list">
            
            <div class="section-title">üì¶ Pending Bills (We Owe Farmer)</div>
            {% for bill in bills %}
            <div class="tx-item">
                {% if bill.status != 'Completed' %}
                    <input type="checkbox" name="bill_ids" value="{{ bill.id }}" form="print-form" style="transform:scale(1.3); margin-top:5px;">
                {% else %}
                    <form action="{{ url_for('undo_settle', id=bill.id) }}" method="POST">
                        <button type="submit" class="btn-undo" title="Undo">‚Ü©Ô∏è</button>
                    </form>
                {% endif %}
                
                <div class="tx-content">
                    <div class="tx-header">
                        <span class="tx-title">PURCHASE ({{ bill.date }})</span>
                        <span class="tx-amount bill-amount">+ ‚Çπ{{ bill.grand_total }}</span>
                    </div>
                    <div style="font-size:0.85em; color:#666;">
                        {{ bill.bags }} Bags | {{ bill.total_kilos }} kg @ ‚Çπ{{ bill.price_per_unit }}
                    </div>
                    
                    <div class="actions">
                        <a href="{{ url_for('edit_bill', id=bill.id) }}" class="btn-edit">Edit</a>
                        <form action="{{ url_for('delete_bill', id=bill.id) }}" method="POST" style="display:inline;">
                            <button type="submit" class="delete-x" onclick="return confirm('Delete Bill?')">√ó</button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}

            <div class="section-title">üí∏ Payments Given (Given by LTKR)</div>
            {% for pay in payments %}
            <div class="tx-item tx-payment">
                
                {% if pay.status != 'Completed' %}
                    <input type="checkbox" name="payment_ids" value="{{ pay.id }}" form="print-form" style="transform:scale(1.3); margin-top:5px;">
                {% else %}
                    <form action="{{ url_for('undo_payment', id=pay.id) }}" method="POST">
                        <button type="submit" class="btn-undo" title="Undo Payment">‚Ü©Ô∏è</button>
                    </form>
                {% endif %}
                
                <div class="tx-content">
                    <div class="tx-header">
                        <span class="tx-title">PAID via {{ pay.method }} ({{ pay.date }})</span>
                        <span class="tx-amount pay-amount">- ‚Çπ{{ pay.amount }}</span>
                    </div>
                    
                    {% if pay.status != 'Completed' %}
                    <div class="actions">
                        <form action="{{ url_for('delete_payment', id=pay.id) }}" method="POST" style="display:inline;">
                            <button type="submit" class="delete-x" onclick="return confirm('Delete Payment?')">√ó</button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        
        </div>

        <div class="footer">
            <div>
                <div style="font-size: 0.9em; color: #777;">NET PENDING PAYABLE</div>
                <span class="final-bal">‚Çπ{{ total_balance }}</span>
            </div>
            <button type="submit" class="btn-print" form="print-form">üñ®Ô∏è Print Statement</button>
        </div>
    </div>

    <script>
        document.getElementById('payDate').valueAsDate = new Date();
    </script>
</body>
</html>